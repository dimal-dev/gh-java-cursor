<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<!-- This is a fragment loaded via AJAX - the weekly schedule grid -->
<div id="week-grid" th:fragment="content">
    <div class="table-responsive">
        <table class="schedule-table">
            <thead>
                <tr class="schedule-table__header">
                    <th th:each="day : ${dayList}">
                        <div class="day-header">
                            <span class="day-header__date" th:text="${day.dateLabel}">1 Jan</span>
                            <span class="day-header__name" th:text="${day.dayLabel}">Mon</span>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody class="schedule-table__body">
                <tr th:each="timeRow : ${timeList}">
                    <td th:each="slot : ${timeRow}"
                        class="time-cell"
                        th:classappend="${slot.cssClass}"
                        th:data-available-at="${#temporals.format(slot.datetime, 'yyyy-MM-dd HH:mm:ss')}"
                        th:data-disabled="0"
                        th:data-state="${slot.state.code}"
                        th:data-available-at-ts-utc="${slot.availableAtTimestampUtc}">
                        <span class="time-cell__time" th:text="${slot.time}">00:00</span>
                        <div class="time-cell__loader" style="display: none;">
                            <div class="spinner-small"></div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // This script initializes the week grid after it's loaded via AJAX
    function initWeekGrid() {
        'use strict';

        const ACTION_ADD = 1;
        const ACTION_REMOVE = 2;
        const STATE_UNUSED = 1;
        const STATE_AVAILABLE = 2;
        const STATE_BOOKED = 3;
        const STATE_DONE = 4;
        const STATE_PASSED = 15;

        let seriesStarted = false;

        function isTouchDevice() {
            return ('ontouchstart' in window) ||
                (navigator.maxTouchPoints > 0) ||
                (navigator.msMaxTouchPoints > 0);
        }

        function handleAction(cell) {
            const disabled = cell.getAttribute('data-disabled');
            const time = cell.getAttribute('data-available-at');
            const state = parseInt(cell.getAttribute('data-state'));

            if (disabled === '1') {
                seriesStarted = false;
                return;
            }

            if (state === STATE_PASSED || state === STATE_DONE) {
                seriesStarted = false;
                return;
            }

            if (state === STATE_BOOKED) {
                seriesStarted = false;
                alert('Cannot toggle booked slots. Go to the Schedule page to cancel consultations.');
                return;
            }

            const isCurrentlyAvailable = state === STATE_AVAILABLE;
            const action = isCurrentlyAvailable ? ACTION_REMOVE : ACTION_ADD;

            showLoader(cell);

            sendToBackend(cell, time, action)
                .then(success => {
                    hideLoader(cell);
                    if (success) {
                        updateCellState(cell, action);
                    } else {
                        alert('Something went wrong. Please try again.');
                        seriesStarted = false;
                    }
                })
                .catch(error => {
                    hideLoader(cell);
                    console.error('Error toggling slot:', error);
                    alert('Something went wrong. Please try again.');
                    seriesStarted = false;
                });
        }

        function showLoader(cell) {
            cell.setAttribute('data-disabled', '1');
            const loader = cell.querySelector('.time-cell__loader');
            if (loader) loader.style.display = 'flex';
        }

        function hideLoader(cell) {
            cell.setAttribute('data-disabled', '0');
            const loader = cell.querySelector('.time-cell__loader');
            if (loader) loader.style.display = 'none';
        }

        async function sendToBackend(cell, time, action) {
            const response = await fetch('/therapist/schedule/book', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ time, action })
            });

            const data = await response.json();
            return data.success;
        }

        function updateCellState(cell, action) {
            // Remove all state classes
            cell.classList.remove('slot-available', 'slot-booked', 'slot-done', 'slot-passed', 'slot-unused');

            if (action === ACTION_REMOVE) {
                cell.setAttribute('data-state', STATE_UNUSED);
                cell.classList.add('slot-unused');
            } else if (action === ACTION_ADD) {
                cell.setAttribute('data-state', STATE_AVAILABLE);
                cell.classList.add('slot-available');
            }
        }

        // Set up event handlers
        const cells = document.querySelectorAll('.time-cell');

        if (isTouchDevice()) {
            cells.forEach(cell => {
                cell.addEventListener('click', () => handleAction(cell));
            });
        } else {
            cells.forEach(cell => {
                cell.addEventListener('mouseenter', () => {
                    if (seriesStarted) {
                        handleAction(cell);
                    }
                });
                cell.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    seriesStarted = true;
                    handleAction(cell);
                });
            });

            document.body.addEventListener('mouseup', () => {
                seriesStarted = false;
            });
        }
    }
</script>
</body>
</html>

