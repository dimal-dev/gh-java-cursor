<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/therapist}">

<head>
    <title th:text="#{therapist.schedule.settings.title}">Schedule Settings - GoodHelp</title>
</head>

<body>
    <main layout:fragment="content" class="cabinet-page schedule-settings-page">
        <div class="page-header">
            <a th:href="@{/therapist/schedule}" class="btn-back">
                <span>‚Üê</span> <span th:text="#{common.back}">Back</span>
            </a>
            <h1 th:text="#{therapist.schedule.settings.heading}">Schedule Settings</h1>
        </div>

        <p class="page-description" th:text="#{therapist.schedule.settings.description}">
            Click on time slots to mark when you're available for consultations.
        </p>

        <!-- Week Selector Buttons -->
        <div class="week-selector">
            <button class="week-btn show-week-button" data-week-number="1"
                th:data-week-day-first="${zeroWeek.startDateFull}">
                <span class="week-btn__label" th:text="#{therapist.schedule.week.current}">Current Week</span>
                <span class="week-btn__dates"
                    th:text="${zeroWeek.startDateLabel + ' - ' + zeroWeek.endDateLabel}">Dates</span>
            </button>
            <button class="week-btn show-week-button" data-week-number="2"
                th:data-week-day-first="${oneWeek.startDateFull}">
                <span class="week-btn__label" th:text="#{therapist.schedule.week.next}">Next Week</span>
                <span class="week-btn__dates"
                    th:text="${oneWeek.startDateLabel + ' - ' + oneWeek.endDateLabel}">Dates</span>
            </button>
            <button class="week-btn show-week-button" data-week-number="3"
                th:data-week-day-first="${twoWeek.startDateFull}">
                <span class="week-btn__label" th:text="#{therapist.schedule.week.third}">Week 3</span>
                <span class="week-btn__dates"
                    th:text="${twoWeek.startDateLabel + ' - ' + twoWeek.endDateLabel}">Dates</span>
            </button>
            <button class="week-btn show-week-button" data-week-number="4"
                th:data-week-day-first="${threeWeek.startDateFull}">
                <span class="week-btn__label" th:text="#{therapist.schedule.week.fourth}">Week 4</span>
                <span class="week-btn__dates"
                    th:text="${threeWeek.startDateLabel + ' - ' + threeWeek.endDateLabel}">Dates</span>
            </button>
        </div>

        <!-- Week Grid Container -->
        <div id="displaying-week-content" class="week-grid-container">
            <div class="loading-spinner">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Legend -->
        <div class="schedule-legend">
            <div class="legend-item">
                <span class="legend-color legend-color--available"></span>
                <span th:text="#{therapist.schedule.legend.available}">Available</span>
            </div>
            <div class="legend-item">
                <span class="legend-color legend-color--booked"></span>
                <span th:text="#{therapist.schedule.legend.booked}">Booked</span>
            </div>
            <div class="legend-item">
                <span class="legend-color legend-color--done"></span>
                <span th:text="#{therapist.schedule.legend.done}">Completed</span>
            </div>
            <div class="legend-item">
                <span class="legend-color legend-color--passed"></span>
                <span th:text="#{therapist.schedule.legend.passed}">Passed</span>
            </div>
        </div>
    </main>

    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            /*<![CDATA[*/
            (function () {
                'use strict';

                const displayingWeekContentEl = document.getElementById('displaying-week-content');
                const activeWeekButtonClassName = 'week-btn--active';
                let loadingWeek = false;

                const messages = {
                    weekUrl: /*[[@{/therapist/schedule/settings/week}]]*/ '/therapist/schedule/settings/week',
                    toggleUrl: /*[[@{/therapist/schedule/book}]]*/ '/therapist/schedule/book'
                };

                // Get CSRF token from meta tag (set by Thymeleaf layout)
                function getCsrfToken() {
                    const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                    const headerName = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';
                    return { token, headerName };
                }

                // Constants for slot states and actions
                const ACTION_ADD = 1;
                const ACTION_REMOVE = 2;
                const STATE_UNUSED = 1;
                const STATE_AVAILABLE = 2;
                const STATE_BOOKED = 3;
                const STATE_DONE = 4;
                const STATE_PASSED = 15;

                // Track drag state for mouse interactions
                let seriesStarted = false;

                /**
                 * Initialize the week grid after it's loaded via AJAX.
                 * Sets up event handlers for time slot cells to toggle availability.
                 */
                function initWeekGrid() {
                    const weekGrid = document.getElementById('week-grid');

                    if (!weekGrid) {
                        console.warn('Week grid container not found');
                        return;
                    }

                    const cells = weekGrid.querySelectorAll('.time-cell');

                    // Remove old listeners by cloning nodes (clean slate approach)
                    cells.forEach(cell => {
                        const newCell = cell.cloneNode(true);
                        cell.parentNode.replaceChild(newCell, cell);
                    });

                    // Get fresh references after cloning
                    const freshCells = weekGrid.querySelectorAll('.time-cell');

                    if (isTouchDevice()) {
                        // Touch devices: single tap to toggle
                        freshCells.forEach(cell => {
                            cell.addEventListener('click', () => handleAction(cell));
                        });
                    } else {
                        // Desktop: mouse drag to toggle multiple slots
                        freshCells.forEach(cell => {
                            cell.addEventListener('mouseenter', () => {
                                if (seriesStarted) {
                                    handleAction(cell);
                                }
                            });
                            cell.addEventListener('mousedown', (e) => {
                                e.preventDefault();
                                seriesStarted = true;
                                handleAction(cell);
                            });
                        });

                        // Stop series on mouse up anywhere
                        document.body.addEventListener('mouseup', () => {
                            seriesStarted = false;
                        });
                    }
                }

                /**
                 * Check if the device supports touch input.
                 */
                function isTouchDevice() {
                    return ('ontouchstart' in window) ||
                        (navigator.maxTouchPoints > 0) ||
                        (navigator.msMaxTouchPoints > 0);
                }

                /**
                 * Handle user action on a time slot cell.
                 * Validates the slot state and toggles availability if allowed.
                 */
                function handleAction(cell) {
                    const disabled = cell.getAttribute('data-disabled');
                    const time = cell.getAttribute('data-available-at');
                    const state = parseInt(cell.getAttribute('data-state'));

                    if (disabled === '1') {
                        seriesStarted = false;
                        return;
                    }

                    if (state === STATE_PASSED || state === STATE_DONE) {
                        seriesStarted = false;
                        return;
                    }

                    if (state === STATE_BOOKED) {
                        seriesStarted = false;
                        alert('Cannot toggle booked slots. Go to the Schedule page to cancel consultations.');
                        return;
                    }

                    const isCurrentlyAvailable = state === STATE_AVAILABLE;
                    const action = isCurrentlyAvailable ? ACTION_REMOVE : ACTION_ADD;

                    showLoader(cell);

                    sendToBackend(cell, time, action)
                        .then(success => {
                            hideLoader(cell);
                            if (success) {
                                updateCellState(cell, action);
                            } else {
                                alert('Something went wrong. Please try again.');
                                seriesStarted = false;
                            }
                        })
                        .catch(error => {
                            hideLoader(cell);
                            console.error('Error toggling slot:', error);
                            alert('Something went wrong. Please try again.');
                            seriesStarted = false;
                        });
                }

                /**
                 * Show loading indicator on a cell.
                 */
                function showLoader(cell) {
                    cell.setAttribute('data-disabled', '1');
                    const loader = cell.querySelector('.time-cell__loader');
                    if (loader) loader.style.display = 'flex';
                }

                /**
                 * Hide loading indicator on a cell.
                 */
                function hideLoader(cell) {
                    cell.setAttribute('data-disabled', '0');
                    const loader = cell.querySelector('.time-cell__loader');
                    if (loader) loader.style.display = 'none';
                }

                /**
                 * Send toggle request to backend.
                 * Includes CSRF token for Spring Security.
                 */
                async function sendToBackend(cell, time, action) {
                    const headers = {
                        'Content-Type': 'application/json',
                    };

                    const csrf = getCsrfToken();
                    headers[csrf.headerName] = csrf.token;

                    const response = await fetch(messages.toggleUrl, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ time, action })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.success;
                }

                /**
                 * Update cell visual state after successful toggle.
                 */
                function updateCellState(cell, action) {
                    // Remove all state classes
                    cell.classList.remove('slot-available', 'slot-booked', 'slot-done', 'slot-passed', 'slot-unused');

                    if (action === ACTION_REMOVE) {
                        cell.setAttribute('data-state', STATE_UNUSED);
                        cell.classList.add('slot-unused');
                    } else if (action === ACTION_ADD) {
                        cell.setAttribute('data-state', STATE_AVAILABLE);
                        cell.classList.add('slot-available');
                    }
                }

                function removeActiveStateFromAllWeekButtons() {
                    document.querySelectorAll('.show-week-button').forEach(el => {
                        el.classList.remove(activeWeekButtonClassName);
                    });
                }

                function addActiveStateToWeekButton(weekButton) {
                    weekButton.classList.add(activeWeekButtonClassName);
                }

                function showSpinner() {
                    displayingWeekContentEl.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                `;
                }

                function loadWeek(weekButton) {
                    if (loadingWeek) return;

                    showSpinner();

                    const weekDayFirst = weekButton.getAttribute('data-week-day-first');

                    removeActiveStateFromAllWeekButtons();
                    loadingWeek = true;
                    weekButton.disabled = true;

                    const url = messages.weekUrl + '?weekDayFirst=' + encodeURIComponent(weekDayFirst);

                    fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.text();
                        })
                        .then(html => {
                            weekButton.disabled = false;
                            loadingWeek = false;

                            addActiveStateToWeekButton(weekButton);

                            // Extract just the content from the HTML response
                            // The response may contain HTML/body tags, so we parse and extract the #week-grid
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const weekGridContent = doc.getElementById('week-grid');

                            if (weekGridContent) {
                                // Insert just the grid content
                                displayingWeekContentEl.innerHTML = weekGridContent.outerHTML;
                            } else {
                                // Fallback: insert the full HTML if parsing fails
                                displayingWeekContentEl.innerHTML = html;
                            }

                            // Initialize the week grid interactions after HTML is inserted
                            initWeekGrid();
                        })
                        .catch(error => {
                            weekButton.disabled = false;
                            loadingWeek = false;
                            console.error('Failed to load week:', error);
                            displayingWeekContentEl.innerHTML = '<div class="error-message">Failed to load schedule. Please try again.</div>';
                        });
                }

                // Attach click handlers to week buttons
                document.querySelectorAll('.show-week-button').forEach(weekButton => {
                    weekButton.addEventListener('click', () => loadWeek(weekButton));
                });

                // Load the first week by default
                document.addEventListener('DOMContentLoaded', () => {
                    const firstButton = document.querySelector('.show-week-button');
                    if (firstButton) {
                        loadWeek(firstButton);
                    }
                });
            })();
            /*]]>*/
        </script>
    </th:block>
</body>

</html>