# Sub-Stage 4.6: User Chat

## Goal
Implement chat functionality for users to message their therapists.

---

## Endpoints

| Method | Route | Handler |
|--------|-------|---------|
| GET | /user/chat | `chatIndex()` |
| GET | /user/chat/{therapistId} | `chatWith()` |
| GET | /user/chat/{therapistId}/messages | `getMessages()` |
| POST | /user/chat/{therapistId}/send | `sendMessage()` |
| GET | /user/chat/unread | `getUnreadCount()` |

---

## Controller

```java
@Controller
@RequestMapping("/user/chat")
public class UserChatController {
    
    @GetMapping
    public String chatIndex(Model model, @AuthenticationPrincipal GoodHelpUserDetails user) {
        var conversations = getConversationsUseCase.forUser(user.getId());
        model.addAttribute("conversations", conversations);
        return "user/chat/index";
    }
    
    @GetMapping("/{therapistId}")
    public String chatWith(@PathVariable Long therapistId, 
                          Model model,
                          @AuthenticationPrincipal GoodHelpUserDetails user) {
        var messages = getMessagesUseCase.execute(user.getId(), therapistId, 0);
        var therapist = getTherapistUseCase.execute(therapistId);
        
        model.addAttribute("messages", messages);
        model.addAttribute("therapist", therapist);
        return "user/chat/conversation";
    }
    
    @GetMapping("/{therapistId}/messages")
    @ResponseBody
    public MessagesResponse getMessages(
            @PathVariable Long therapistId,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(required = false) Long afterId,
            @AuthenticationPrincipal GoodHelpUserDetails user) {
        return getMessagesUseCase.execute(user.getId(), therapistId, page, afterId);
    }
    
    @PostMapping("/{therapistId}/send")
    @ResponseBody
    public MessageDto sendMessage(
            @PathVariable Long therapistId,
            @RequestBody SendMessageRequest request,
            @AuthenticationPrincipal GoodHelpUserDetails user) {
        var command = new SendMessageCommand(
            user.getId(), therapistId, request.content(), SenderType.USER);
        return sendMessageUseCase.execute(command);
    }
    
    @GetMapping("/unread")
    @ResponseBody
    public UnreadResponse getUnreadCount(@AuthenticationPrincipal GoodHelpUserDetails user) {
        return new UnreadResponse(chatService.getUnreadCount(user.getId()));
    }
}
```

---

## Chat Features

### Conversation List
- Shows all therapists user has messaged
- Last message preview
- Unread count per conversation
- Therapist photo

### Conversation View
- Message history
- Send new message
- Auto-mark as read when viewed
- Poll for new messages

---

## Templates

```html
<!-- user/chat/index.html -->
<section class="chat-list">
    <h1 th:text="#{user.chat.title}">Messages</h1>
    
    <div th:if="${#lists.isEmpty(conversations)}" class="empty-state">
        <p th:text="#{user.chat.noConversations}">No conversations yet</p>
    </div>
    
    <div th:each="conv : ${conversations}" class="conversation-item">
        <a th:href="@{/user/chat/{id}(id=${conv.therapistId})}">
            <img th:src="${conv.therapistPhotoUrl}" class="avatar">
            <div class="info">
                <h3 th:text="${conv.therapistName}">Name</h3>
                <p th:text="${conv.lastMessage}">Last message...</p>
            </div>
            <span th:if="${conv.unreadCount > 0}" class="badge" 
                  th:text="${conv.unreadCount}"></span>
        </a>
    </div>
</section>
```

---

## JavaScript

```javascript
// Poll for new messages every 5 seconds
const pollInterval = setInterval(async () => {
    const lastId = getLastMessageId();
    const response = await fetch(`/user/chat/${therapistId}/messages?afterId=${lastId}`);
    const data = await response.json();
    if (data.messages.length > 0) {
        appendMessages(data.messages);
    }
}, 5000);
```

---

## PHP Reference
- `original_php_project/src/User/Controller/Chat/`

---

## Verification
- [ ] Conversation list shows therapists
- [ ] Can view message history
- [ ] Can send messages
- [ ] Messages marked as read
- [ ] Polling works for new messages
- [ ] Unread badge updates

---

## Next
Proceed to **4.7: Consultations**

